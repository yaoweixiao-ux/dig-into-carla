鱼眼相机改动说明与补丁包

概述
- 新增/完善 `sensor.camera.fisheye` 传感器，支持标准分辨率属性、鱼眼内参与可选立方体贴图面尺寸以降低显存占用。
- 修复与统一数据发送路径，避免不同 CARLA 版本序列化风格混用导致的编译/运行问题。
- 修复 ImageSerializer 在 Clang 下的窄化告警（uint32_t 显式转换）。
- 更新示例：manual_control 与 fisheyes_demo，便于快速验证。

变更清单（文件）
- Unreal 侧
  - Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Sensor/FisheyeSensor.h
  - Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Sensor/FisheyeSensor.cpp
  - Unreal/CarlaUE4/Plugins/Carla/CarlaDependencies/include/carla/sensor/s11n/ImageSerializer.h
- LibCarla 侧
  - LibCarla/source/carla/sensor/s11n/ImageSerializer.h
- Python 示例
  - PythonAPI/examples/manual_control.py
  - PythonAPI/examples/fisheyes_demo.py

实现原理与设计要点
- 投影模型
  - 采用基于 KB (Kannala–Brandt) 的鱼眼相机模型：将 6 面立方体渲染目标经 `CubemapHelpersFisheye::GenerateLongLatUnwrapFisheye` 拆卷为鱼眼图像；
  - 畸变参数 `d_1..d_4`、主点 `c_x/c_y`、焦距 `f_x/f_y` 与视角 `max_angle` 通过 Blueprint 属性传入并写入 shader/拆卷参数。
- UE 引擎依赖
  - 需要引擎端补丁：`CubemapUnwrapUtils.{h,cpp}` 与 `SimpleElementPixelShader.usf`，提供 `GenerateLongLatUnwrapFisheye` 与对应 fisheye 畸变实现。
  - 若未打补丁，将出现找不到头文件或链接符号的错误。

引擎补丁步骤（UE 4.26）
- 准备
  - 确认你的 UE 源码路径，例如 `~/WorkSpace/UnrealEngine`，分支版本为 4.26.x；确保能正常编译运行。
  - 关闭所有使用该引擎的 UE 编辑器/进程，避免文件占用。
- 修改 1：新增/扩展 Cubemap 拆卷接口
  - 文件：`Engine/Source/Runtime/Engine/Public/CubemapUnwrapUtils.h`
    - 添加命名空间 `CubemapHelpersFisheye`，声明：
      - 结构体 `FFisheyeParams { FIntPoint ImageSize; FVector4 CameraMatrix; FVector4 DistortionCoeffs; float MaxAngle; };`
      - 函数 `bool GenerateLongLatUnwrapFisheye(const UTextureRenderTargetCube* / FTextureResource*, TArray64<uint8>& OutPixels, FFisheyeParams& Params, FIntPoint& OutSize, EPixelFormat& OutFormat);`
    - 若已有 `CubemapHelpers`/`CubemapHelpersFisheye`，合并或对齐已有接口。
  - 文件：`Engine/Source/Runtime/Engine/Private/CubemapUnwrapUtils.cpp`
    - 按上述声明实现 `CubemapHelpersFisheye::GenerateLongLatUnwrapFisheye`：
      - 通过 `UTextureRenderTargetCube::GameThread_GetRenderTargetResource()` 取得 `FTextureRenderTargetCubeResource`；
      - 读取 6 面贴图像素（或调用已有长宽展开工具）；
      - 将像素通过 KB 模型进行重映射，生成目标分辨率的鱼眼图像，写入 `OutPixels` 与 `OutSize/OutFormat`。
    - 注意：实现需在游戏线程调用（内部使用 `GameThread_GetRenderTargetResource`）。
- 修改 2：Shader 畸变实现
  - 文件：`Engine/Shaders/Private/SimpleElementPixelShader.usf`
    - 增加/扩展鱼眼畸变计算函数（示例名）：`CubemapTexturePropertiesFisheye`；
    - 关键公式（KB 模型）：`theta = r / (1 + d1*th2 + d2*th4 + d3*th6 + d4*th8)`，其中 `r` 为径向距离、`th2 = theta^2` 等；
    - 将 `d1..d4`、`fx/fy`、`cx/cy`、`max_angle` 作为参数/常量传入，参与像素重映射。
  - 如使用自定义后处理材质代替 usf，可在材质中实现投影并输出至 2D RT，然后仅复用 Cubemap 工具或完全跳过 Cubemap；但本实现默认使用 Cubemap 路径。
- 重新编译与清理
  - 首次修改引擎 Shader，请清理 `DerivedDataCache`（缓存目录常见于 `~/.cache/UnrealEngine/<version>/` 或工程下 `Saved/DerivedDataCache`）。
  - 重新编译引擎或目标项目（CarlaUE4）以触发 Shader 重新编译与引擎源码变更生效。
  - Linux 可直接在 CarlaUE4 侧 `make launch`，或在 UE 源码目录运行 `Engine/Build/BatchFiles/Linux/Build.sh` 重新构建；Windows 使用 `GenerateProjectFiles.bat` + VS 构建。
- 验证
  - 编译 Carla 插件，确认包含 `#include "CubemapUnwrapUtils.h"` 的目标能通过编译与链接；
  - 运行 `manual_control.py`，切换到“Camera Fisheye”观察是否有畸变输出；
  - 若出现“找不到符号/头文件”或 `IsInGameThread()` 断言，请检查：
    - 头/源文件是否位于正确的引擎路径；
    - `GenerateLongLatUnwrapFisheye` 是否在游戏线程调用；
    - Shader 是否已重新编译（查看控制台日志）。
- 注意事项
  - 引擎更新可能覆盖你本地的 usf/cpp 修改，升级引擎后需要重新合并补丁；
  - 生产环境建议以 Git 补丁或自定义分支的方式维护这些修改，避免误差。
- 线程模型
  - `GenerateLongLatUnwrapFisheye` 内部调用 `GameThread_GetRenderTargetResource`，必须在游戏线程执行，禁止在渲染线程调用，否则触发 `IsInGameThread()` 断言崩溃。
  - 本实现将拆卷与打包均放在游戏线程（Pre/ PostPhysTick 流程内），仅网络发送使用已有数据流异步化。
- 数据发送路径
  - 统一采用和 `FPixelReader` 一致的路径：
    1) `Stream.PopBufferFromPool()` 取缓冲；
    2) 将像素拷贝到 `header_offset` 之后；
    3) `Stream.Send(Sensor, std::move(Buffer))`；
  - 由 `FAsyncDataStreamTmpl::Send` 调用 `SensorRegistry::Serialize` 写入图像头（width/height/fov）；
  - 修复了 `ImageSerializer::Serialize` 的宽高类型窄化：显式 `static_cast<uint32_t>(sensor.GetImageWidth/Height())`。

关键改动摘要
- FisheyeSensor 接口
  - GetImageWidth/Height 继续返回 Blueprint 友好的 `int32`；
  - 新增属性 `cube_size`（可选，默认使用图像宽度），用作立方体贴图面尺寸，显著降低显存占用；
  - 支持读取标准分辨率 `image_size_x/image_size_y`，并兼容旧的 `x_size/y_size`；
  - `SendPixelsInRenderThread` 重写为在游戏线程进行拆卷与发送；
  - BeginPlay 初始化立方体贴图尺寸时优先采用 `cube_size`。
- ImageSerializer（两处）
  - 对宽/高进行 `uint32_t` 显式转换，消除 Clang `-Wc++11-narrowing` 告警/错误。
- 示例
  - manual_control.py：新增 fisheye 传感器项，支持环境变量配置鱼眼材质与内参；
  - fisheyes_demo.py：改为标准分辨率属性，新增输出目录创建、设置 `cube_size=512` 与 `sensor_tick=0.05` 以降低 GPU 压力。

使用说明（简）
- 引擎补丁：确保 UE4.26 工程已应用鱼眼相关补丁（CubemapUnwrapUtils 与 usf 修改）。
- 编译运行：
  - Linux: 在 Unreal/CarlaUE4 目录编译运行（或 `make launch`）。
  - 初次测试建议分辨率 800x600、`cube_size=512`，逐步升高。
- manual_control：
  - 可通过环境变量传入内参与材质，例如：
    - `CARLA_FISHEYE_MATERIAL`、`CARLA_FISHEYE_MAX_ANGLE`、`CARLA_FISHEYE_D1..D4`、`CARLA_FISHEYE_FX/FY/CX/CY`。
- fisheyes_demo：
  - 已默认 1280x720、`cube_size=512`、`sensor_tick=0.05`，输出至 `./fisheye_data`。

常见问题与建议
- Vulkan 设备内存不足：
  - 降低 `image_size_x/y`、`cube_size`，或降低帧率（增大 `sensor_tick`）。
  - 尝试以 OpenGL 启动（命令行 `-opengl`）。
  - 确认 8-bit 纹理格式（代码已使用 PF_B8G8R8A8）。
- 若仍出现线程断言：确认 fisheye 拆卷函数未在渲染线程调用；本实现已固定于游戏线程执行。

补丁包
- 补丁文件：`Docs/patches/fisheye_changes.patch`
- 说明：该补丁按本仓库当前改动生成，如需应用到上游仓库，请注意对应文件路径可能不同；建议在目标工程上手工比对合并。

版本兼容
- UE 4.26；CARLA 0.9.1x 系列（以当前工程为准）。若在较老/较新 CARLA 分支使用，需确认 SensorRegistry 与 ImageSerializer 接口未发生重大变更。
